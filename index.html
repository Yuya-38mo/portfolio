<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>AR体験ページ</title>
    <!-- A-Frameを読み込み -->
    <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
    <!-- AR.jsを読み込み -->
    <script src="https://jeromeetienne.github.io/AR.js/aframe/build/aframe-ar.js"></script>
    <!-- スクショ用スクリプトを読み込み -->
    <script>
        var image = document.querySelector('#snap');
        var take_photo_btn = document.querySelector('#take-photo');
        var delete_photo_btn = document.querySelector('#delete-photo');
        var download_photo_btn = document.querySelector('#download-photo');
        
        //スナップショットボタン
        take_photo_btn.addEventListener("click", function (e) {
            var download_photo_btn = document.querySelector('#download-photo');
            e.preventDefault();
            var video = document.querySelector('video');
            var snap = takeSnapshot(video);
            //スナップショット表示.
            image.setAttribute('src', snap);
            image.classList.add('visible');
            
            // 削除ボタンと保存ボタン有効
            delete_photo_btn.classList.remove("disabled");
            download_photo_btn.classList.remove("disabled");

            // 保存ボタンにスナップショットを渡す
            download_photo_btn.href = snap;
        });

    //削除ボタン
    delete_photo_btn.addEventListener("click", function(e){

        e.preventDefault();

        // スナップショットを隠す
        image.setAttribute('src', "");
        image.classList.remove("visible");

        // 削除ボタンと保存ボタン無効
        delete_photo_btn.classList.add("disabled");
        download_photo_btn.classList.add("disabled");

    });

    //スナップショットを撮る
    function takeSnapshot(video) {
        var resizedCanvas = document.createElement("canvas");
        var resizedContext = resizedCanvas.getContext("2d");
        var width = video.videoWidth;
        var height = video.videoHeight;
        var aScene = document.querySelector("a-scene").components.screenshot.getCanvas("perspective");

        if (width && height) {
            //videoのサイズをキャンバスにセット
            resizedCanvas.width = width;
            resizedCanvas.height = height;
            //キャンバスにvideoをコピー
            resizedContext.drawImage(video, 0, 0, width, height);

            //カメラの画角でar側の縮小処理を変える
            if (width > height) {
                // 横長（PC)
                resizedContext.drawImage(aScene, 0, 0, width, height);
            } else {
                // 縦長（スマホ）
                var scale = height / width;
                var scaledWidth = height * scale;
                var marginLeft = (width - scaledWidth) / 2;
                resizedContext.drawImage(aScene, marginLeft, 0, scaledWidth, height);
            }
            return resizedCanvas.toDataURL('image/png');
        }
    }
</script>
    
    <!-- アイコン素材の読み込み -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- スタイルシートを読み込み -->
    <link rel="stylesheet" href="css/style.css" type="text/css">
</head>

<body style="margin:0px; overflow:hidden;">
    <!-- A-Frame の VR空間に AR.js を紐づける（デバッグUIは非表示） -->
    <a-scene embedded arjs="debugUIEnabled:false;">

        <!-- OBJ形式のCGモデルの読み込み -->
        <a-assets>
            <!-- objファイル -->
            <a-asset-item id="obj" src="model/harotore2.obj"></a-asset-item>
            <!-- mtlファイル -->
            <a-asset-item id="mtl" src="model/harotore2.mtl"></a-asset-item>
            <!-- 画像をプリロード -->
            <img id="logo" src="model/isepoly.jpg">
        </a-assets>

        <!-- マーカーを登録（作成したQRコードマーカー） -->
        <a-marker type="pattern" url="pattern-hellotrain.patt">
            
            <!-- マーカーの場所に OBJ 形式の 3DCG を置く -->
            <a-entity animation="property: rotation; to: 0 360 0; loop: true; dur: 7500">
                <a-obj-model src="#obj" mtl="#mtl" scale="0.04 0.04 0.04" position="-1.5 0.5 0"></a-obj-model>
                <!-- アニメーション（旧バージョン） -->
                <!--
                    <a-animation attribute="rotation" to="0 360 0" dur="6000" repeat="indefinite" easing="linear"></a-animation>
                -->
            </a-entity>
                
            <!-- 画像を出力 -->
            <a-image src="#logo" width="2" height="0.4" rotation="-60 0 0" position="0 -0.5 0"></a-image>
         
        </a-marker>

        <!-- AR用のカメラを置く -->
        <a-entity camera></a-entity>
        
        <!-- スクショボタン -->
        <div class="ui">
            <img id="snap">
            <a href="#" id="delete-photo" title="Delete Photo" class="disabled"><i class="material-icons">delete</i></a>
            <a href="" id="take-photo" title="Take Photo"><i class="material-icons">photo_camera</i></a>
            <a href="#" id="download-photo" download="selfie.png" title="Save Photo" class="disabled" target="_blank"><i class="material-icons">file_download</i></a>
        </div>

    </a-scene>
</body>

</html>
